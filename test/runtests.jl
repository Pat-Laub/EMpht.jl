using Distributions
using EMpht
using LinearAlgebra: norm
using Random
using Test

# Fit a simple exponential distribution using
# both methods (uniformization and the ODE solver)
trueRate = 10
trueDist = Exponential(1/trueRate)

# The random number generator changed over time, so I just
# brought in the original random values here to keep the tests stable.

# Random.seed!(1)
# sortedObs = sort(rand(trueDist, 1_000))
sortedObs = [4.5202138622195474e-5, 0.00010438713249897412, 0.00011954308599210157, 0.0003557060310201015, 0.0005775827570180246, 0.00068132796878767, 0.0008564243041523827, 0.0008573392299314942, 0.0008665826527750474, 0.0010408733960411982, 0.0010416885671733157, 0.00113059785648038, 0.0012989301257507336, 0.0014100535393260132, 0.0014557915015520175, 0.0014791397665246085, 0.0015918610972404182, 0.0016176196518802933, 0.0017413305270058096, 0.0018226816278487587, 0.001833515921654758, 0.0019692975816394133, 0.002006487275100478, 0.0020177036510954176, 0.002143918905090262, 0.0022356383838834652, 0.002424548934919302, 0.0024383951508253872, 0.0027262372718669216, 0.0027788345387187233, 0.0029230004411609756, 0.0030544739544362725, 0.0030891472514085402, 0.0031911521965701825, 0.0033366718136926656, 0.003354861761631987, 0.00350380847700266, 0.0035298372546329216, 0.0037030176807567126, 0.0037323023824243095, 0.004077790730085413, 0.004530304750915198, 0.0046370683197606245, 0.004721776153395999, 0.004813339774586511, 0.00483200374768754, 0.00489901287720695, 0.005086888261335631, 0.005163441590642971, 0.005352650768031048, 0.00541991130230678, 0.005589163768790947, 0.00583176253308456, 0.006001854406100061, 0.006173563699926783, 0.0063527272701244045, 0.006400985496882327, 0.0064166804156992364, 0.006679266800560125, 0.006695365071433816, 0.006840193853486401, 0.006874785272737188, 0.007088111271194433, 0.007309633325001204, 0.007345030919784958, 0.007459706276435563, 0.0074918295204640835, 0.007498883183074206, 0.007504386503851277, 0.007516541337235823, 0.00764323200892561, 0.007784137299378019, 0.007820668786369714, 0.008124419681892063, 0.00822047011016539, 0.00832516968576, 0.008502545289589212, 0.00877493183616821, 0.008796815480815462, 0.008838287411852865, 0.008934316014906943, 0.009067652947794559, 0.009250703292130477, 0.009290153636769638, 0.009516558453322652, 0.009637983308124383, 0.009837259458410439, 0.009859462058275145, 0.009883010255779544, 0.009966332923406776, 0.01003642231828857, 0.010245556042417121, 0.010283299500147999, 0.010498783996222186, 0.010612108040205376, 0.010652072830894109, 0.010818479012962377, 0.010944771214550952, 0.011000920027437503, 0.011074743305246632, 0.011165407515651574, 0.011382841375634575, 0.011423112130999715, 0.011426423942199455, 0.011514257058584332, 0.011518445195298543, 0.011589973883145395, 0.011635264979848044, 0.011679593749713842, 0.011902102420310366, 0.011936840505092116, 0.012153562036718003, 0.012375407495358856, 0.012570319132183242, 0.012724488902142318, 0.012816664640153028, 0.012937803757962055, 0.012954398431512155, 0.012979559806633081, 0.01311910518716056, 0.013135335791754688, 0.013200760541154242, 0.013494556894032537, 0.013506828992602785, 0.013584754745136485, 0.013604436806506063, 0.013776128970764105, 0.013979132552982543, 0.014075269544716324, 0.014390635658449473, 0.015027858489748398, 0.015070752822167521, 0.015135702884607095, 0.015160522924165516, 0.01537604780131833, 0.01541161295653589, 0.015437296254067374, 0.015663451989612477, 0.015787805666021847, 0.015832476603265627, 0.015856313265440906, 0.016002259621442742, 0.016243721363520446, 0.016260676477326434, 0.01649139837319985, 0.01657726744724868, 0.0166219001826634, 0.01666010081890179, 0.016689591422403578, 0.016779156532007813, 0.01693526931765009, 0.01755123819426036, 0.01759854174573261, 0.01760588475170674, 0.01760604029465331, 0.017736589439396856, 0.017787993519891944, 0.017874540879936493, 0.017951590385527707, 0.018007416956666973, 0.018024722944741754, 0.018074306763183286, 0.01815881496237791, 0.01821747751745774, 0.018434837622084043, 0.018546217294622577, 0.018714564430966304, 0.018858804065105837, 0.019206353232781345, 0.01923262989167628, 0.019245432068745422, 0.019398822028551935, 0.01957928014207126, 0.01958010447818629, 0.019946588896060463, 0.020110779114665463, 0.020318955381047204, 0.020451768310019002, 0.020574036988264637, 0.020666792427984537, 0.020834682957452215, 0.020861397123876108, 0.02090853755935118, 0.02090897286378715, 0.021007378316851424, 0.021093342858699307, 0.02114347478717271, 0.021158991777315825, 0.02115971052626885, 0.021395054494200403, 0.02141188126679036, 0.02142971851576466, 0.021433233225321504, 0.021434007296590108, 0.021437289221972165, 0.021589083788455476, 0.02169815058019333, 0.021783254285271753, 0.02179040961343418, 0.021927972371431702, 0.02226948444484604, 0.02231973066230454, 0.022559981383242333, 0.02261304502358295, 0.022742981273839193, 0.022745809673388736, 0.0227736898582483, 0.022845749641407165, 0.02294103653326154, 0.023061664804696045, 0.023270217712928542, 0.023483012962933075, 0.023489696163875706, 0.023653173661171794, 0.02368824583504816, 0.02394306952070244, 0.02400387791923315, 0.024012292978099183, 0.02402824276557683, 0.02413407736500145, 0.024155712668577668, 0.02418082813777883, 0.024238117375451812, 0.024305901429475522, 0.02449742354823106, 0.02459756567103157, 0.024690129566943872, 0.024722008882113233, 0.024753899966939674, 0.024792642866338088, 0.024808996833038745, 0.025175022689807394, 0.02518027242420789, 0.025374788976179077, 0.025503294801592608, 0.02552558991632454, 0.025683312766455316, 0.02605492551350911, 0.026063974696795517, 0.026168237603957076, 0.026187195061086122, 0.026287531207168757, 0.026593587695701873, 0.026752029212947538, 0.02676548181384555, 0.027034098402079577, 0.027092785470532, 0.027323056627372194, 0.027526088521550376, 0.028252784229301265, 0.028778590750545598, 0.028914693711873236, 0.028964763720519676, 0.02906918426529824, 0.02908059524772327, 0.029256448016468446, 0.029267842149843206, 0.029309836329803163, 0.02937657483764777, 0.02939844383993173, 0.029659266684697157, 0.029707861932966418, 0.02987040934229552, 0.029963680039699354, 0.030200003024507174, 0.03020880001914339, 0.030245301685979744, 0.03030284987646034, 0.0305273364325903, 0.030539293868327117, 0.03072175255785933, 0.03077019353590433, 0.030944807100493056, 0.03099172498012699, 0.031046414219821662, 0.03109521519615885, 0.031120832497944326, 0.031143198243574033, 0.03115973705116149, 0.031404149972717545, 0.03142404254735234, 0.03155301540374247, 0.031570738251551315, 0.03159187937604198, 0.031638029726409465, 0.03201486842307395, 0.03201988234732773, 0.03206569707077816, 0.03208300999160018, 0.03271292674097929, 0.032994223833021655, 0.03304417061680834, 0.03323098314738223, 0.03342356654894664, 0.03342613040336922, 0.033496414389370455, 0.03351166300096293, 0.03353930012475375, 0.033583946807247245, 0.03363780654205139, 0.03379042487459023, 0.033897422939570675, 0.03406265200747291, 0.03407302063868162, 0.03411444490879841, 0.03415610922310326, 0.03446464939874573, 0.03449562594165397, 0.034652211304380225, 0.034758028094423916, 0.035215760937283784, 0.03587728552336166, 0.036103503612689776, 0.0363283772077855, 0.036478491447539035, 0.036725549592509774, 0.03679115627156828, 0.03707647397631172, 0.037163812757075754, 0.03734351009056663, 0.03758086476913031, 0.037648473211379666, 0.03772935768553752, 0.037886551344749, 0.03825063422252217, 0.03827022592977799, 0.03827650505155149, 0.03864486903699544, 0.038805884623955, 0.03896722064021743, 0.03946873492228648, 0.03962964580394873, 0.0398943353439818, 0.0400203176301501, 0.04007739683526458, 0.040201416381815035, 0.04038956254253071, 0.04041473703909564, 0.040637090507389416, 0.04081484639256585, 0.04091177717736032, 0.040945047290447914, 0.04104459035171554, 0.04109916458942186, 0.04130354163961854, 0.041347541026917234, 0.0413646196023075, 0.04140374467089192, 0.041768842193653635, 0.04187259832184346, 0.04193622716696525, 0.04198163236426456, 0.04208346846171984, 0.04220783898843615, 0.04228387394994626, 0.0424290415818814, 0.0425271036912942, 0.04253626877539867, 0.04296374713495878, 0.04301076041573477, 0.04324882111055453, 0.043273426799624634, 0.04338097715979838, 0.04429934897306564, 0.04451125557262622, 0.04467723898012446, 0.044822265712021046, 0.04488714962683096, 0.04489697928804946, 0.044924159732713936, 0.04522474376181075, 0.04544662371627994, 0.04552379581014093, 0.045606019739562534, 0.045678361592775586, 0.04578069346685895, 0.04588783750900838, 0.04599952965139109, 0.04611140014388182, 0.04620516622362568, 0.046226024601473445, 0.04649073872720172, 0.04669409018042009, 0.04674255202904906, 0.046771483401220885, 0.04688531393590468, 0.04718006890967372, 0.04720763404976222, 0.04724248182699244, 0.04730561125491864, 0.04783330501938755, 0.047972689210303544, 0.04798429863129228, 0.047990639886453676, 0.048169756852677124, 0.04838123263455616, 0.048528995288062225, 0.0486914542784475, 0.04912871774280563, 0.049182806834731134, 0.04933079791681923, 0.04969001908161383, 0.049826307177751675, 0.05024575103312928, 0.050256727948877214, 0.0502740706923123, 0.050338940893058265, 0.05117737151294545, 0.051200082134942315, 0.05206784689732195, 0.05212523509924118, 0.05212748367263741, 0.052132399317156054, 0.052137206525275426, 0.05247502066460502, 0.052591700697529976, 0.0526297430232895, 0.05268590427314754, 0.05298137946389412, 0.05307741946243845, 0.053081468481908284, 0.05326588246829678, 0.0533242232456039, 0.0533475439095978, 0.05335837452711139, 0.054022305000623196, 0.05402446999272819, 0.05405138907520299, 0.054295605238949274, 0.05463165511785384, 0.05466137512270545, 0.054721472064354175, 0.05486833738823624, 0.05514911887381518, 0.055249565547220374, 0.05525727436920006, 0.05556213586359387, 0.055937806606128695, 0.056263726611861256, 0.05704834744535162, 0.057176129434359235, 0.057231002872341265, 0.057564698559995686, 0.05829242061236587, 0.05834849498999002, 0.05857905059271651, 0.058752463041076765, 0.05896310436325414, 0.05949396913465907, 0.05950175799989654, 0.059518410276667856, 0.05968090606386192, 0.059899589944962056, 0.06000493695262665, 0.06015565216100364, 0.06019886192194878, 0.06034904826568757, 0.060367879602730726, 0.06040149865685273, 0.060440330583328566, 0.06053639177435746, 0.06060099627947836, 0.060656620213291546, 0.06072236974221638, 0.06110737648931015, 0.061342971125038885, 0.0614055010389343, 0.0614499025119039, 0.06178225547966079, 0.06199562147086566, 0.062087503372401424, 0.06223475216310059, 0.06241208399484143, 0.06254152329798683, 0.06258382771126736, 0.06272473259259478, 0.0627868919818577, 0.06289875695649838, 0.06312251228158781, 0.06315943593643597, 0.06323127030108028, 0.06328108584930725, 0.06354806356975, 0.06361866965012639, 0.06382058985953719, 0.06388718857997361, 0.06391687059481052, 0.0640209280628559, 0.06406714765337446, 0.06421388236282062, 0.06431814151967225, 0.06441165946008909, 0.06447593582763697, 0.06449392728677385, 0.06487769842703021, 0.06488595835072748, 0.0650756858116851, 0.06539153476935976, 0.06551961757332894, 0.06560834428271188, 0.06593155137854466, 0.06598498205138559, 0.0660971030070833, 0.06660048396351885, 0.06667619397668066, 0.06723422313353754, 0.0672923493448683, 0.06739759818722733, 0.06746152161558829, 0.06790485880904078, 0.06820326590316456, 0.06820381676201345, 0.06821284786260177, 0.06826160033750417, 0.06827469007427664, 0.06827575698522052, 0.06882680623308737, 0.06954764231808148, 0.0697228112344336, 0.06995301345703457, 0.06999105922538042, 0.07003351074989729, 0.07046784641154857, 0.07051383415057126, 0.0709516812147896, 0.07119765417292766, 0.07176958223106938, 0.07186487506493283, 0.07213717394694379, 0.07241882032004741, 0.07252862300990764, 0.07268739664152955, 0.07269213936957751, 0.07352290738180904, 0.07361696448256637, 0.07369890083409252, 0.07397217728111204, 0.07420063476087489, 0.0743146523020422, 0.07452361089164772, 0.07454562557925264, 0.07457739831371922, 0.07461044200775996, 0.07461912859520319, 0.074799038491808, 0.07530760301572707, 0.07571060382472214, 0.07594187421635915, 0.07636137544944353, 0.0770349390510602, 0.07772967832868335, 0.07791599662870356, 0.07834450732221872, 0.07849117523338812, 0.07857456781134288, 0.07885121649098553, 0.0788653280585493, 0.07913727494777589, 0.0791539258742269, 0.07923974329512734, 0.07925886650180686, 0.0793670839066194, 0.07956592071246561, 0.07989909554840917, 0.0816385887322279, 0.08167629777579752, 0.08188011642772473, 0.08218707475512038, 0.08241860233847022, 0.08253617924933436, 0.08261573368110384, 0.0826815767959172, 0.0835571138488909, 0.08430787657264882, 0.08435131320934527, 0.08451343089494374, 0.08482819444685119, 0.08495311125965027, 0.08498433965553107, 0.08520677899738892, 0.08527027370464929, 0.08527734373552266, 0.08533336420046655, 0.0855293095427524, 0.08562751331843255, 0.08585127333732867, 0.08615261132557261, 0.0866811492081672, 0.08671184431187438, 0.08682551466670267, 0.08712813228808412, 0.08713301636277605, 0.08745959436266051, 0.08746670893025268, 0.08796640319741394, 0.08798823009607885, 0.0880979819557852, 0.08825693920281859, 0.08835951110395317, 0.08837564570332718, 0.08876184217724219, 0.0888096775798667, 0.08902430624580886, 0.08923778402858606, 0.08974726021660107, 0.08992323217136092, 0.09000713165614915, 0.09029821357295109, 0.09037691046251249, 0.09064870496376755, 0.0906968991530868, 0.09116775506501756, 0.09126615187460435, 0.09135994359682509, 0.0914429790593963, 0.09201240495007547, 0.0924896493111448, 0.09314345891592443, 0.09375213674597616, 0.0940756987193296, 0.09498681582658401, 0.09500362042065107, 0.09541373663618302, 0.09558026127092153, 0.09667742801391578, 0.09727871734065262, 0.0973475304960788, 0.09748274327667922, 0.09751652049119602, 0.09752053734300092, 0.09778639940137104, 0.09787054861044386, 0.09792060450476149, 0.0986492960413075, 0.09953578774757922, 0.0998622921501631, 0.10001170588103213, 0.10038214645086883, 0.10081594787796902, 0.10117171207565234, 0.10132339806910506, 0.10169035374003091, 0.10182298831778709, 0.10188069714541255, 0.10192138186650941, 0.10200957201947403, 0.10204915005469942, 0.10254457467904739, 0.10265889176425498, 0.10266209341301105, 0.10266409365343734, 0.10268405485749266, 0.10272621752647489, 0.10313035371215598, 0.10349047657228677, 0.10355869936605072, 0.10364723188152979, 0.10425773875411351, 0.10458006055166198, 0.10519813168341173, 0.10547045654428343, 0.10571050353349559, 0.10585261881182217, 0.10598180312551005, 0.10598789690279223, 0.10627303967631688, 0.10677578139662161, 0.10680824584829003, 0.10688354929093163, 0.10747020952550577, 0.10748710624602711, 0.10793185886066775, 0.10798449958699052, 0.1080659755079148, 0.10818426031919155, 0.10837006002586128, 0.1085873134035049, 0.10910575544969559, 0.10926391956080204, 0.109485316840265, 0.10958143242947015, 0.10967129615298402, 0.10988156049319153, 0.11082738497874829, 0.11141771128194339, 0.11153334327485508, 0.11163576335010605, 0.11167475760152566, 0.11171568727983555, 0.11204857940856815, 0.11247224777878817, 0.11269433368790222, 0.11277250971774154, 0.1137106442508134, 0.11377448975752479, 0.11386874026864997, 0.11390866885700549, 0.11428128063567833, 0.11428678416242632, 0.1147956084366715, 0.11536730641162214, 0.11558650024393352, 0.11584812067027468, 0.1159604270629096, 0.11603130995087028, 0.11613557354440218, 0.11674229362183784, 0.11682945278766498, 0.11694075851815666, 0.1170859875722649, 0.11735206487693642, 0.11753709068143446, 0.11815704914672319, 0.11820052490528754, 0.11820910002821594, 0.11847843124524644, 0.11911698360418838, 0.11960202884054788, 0.11961257339809449, 0.1196990730198261, 0.11999977329669816, 0.12057751025749275, 0.12103047448832821, 0.12181680445947084, 0.12317259790404118, 0.1232778842124651, 0.12341025731061946, 0.12364409082376569, 0.12391946547832625, 0.12400174057726476, 0.12405190672317463, 0.12420352902192644, 0.12427505494363894, 0.1242914059558278, 0.1245706006009431, 0.12564683735430468, 0.12565948145144915, 0.12595698334098945, 0.12727307612368177, 0.12805957461111792, 0.12813283707564052, 0.1283644670347911, 0.1285237967676098, 0.1287331964754765, 0.12885297292397715, 0.1289142260851716, 0.12911425031034887, 0.12927300031788586, 0.1293255712565409, 0.12933084755259028, 0.12945139955183602, 0.12971045560136837, 0.12978785024940395, 0.13048027961446826, 0.1305886154397474, 0.13074430280294574, 0.13108709042903263, 0.13114980559556594, 0.13150919883555737, 0.1317943158713977, 0.13363891149451107, 0.1347705903616588, 0.13514089837759524, 0.13587449297323567, 0.13625693881696543, 0.13627991491356392, 0.13629593274275084, 0.13689750580610335, 0.13714050256865457, 0.13720830566140776, 0.13722015134057985, 0.13745739144218655, 0.1378846596511105, 0.13805070775781894, 0.13815730941407164, 0.13847714884726964, 0.1390559137283438, 0.13924005180820428, 0.13932967946615935, 0.13949875038936735, 0.14039670013168556, 0.14055301891305827, 0.14066310122923106, 0.1409110572790715, 0.14092553023128954, 0.14100787506886966, 0.14114129900157282, 0.14153545204267665, 0.1417355645655795, 0.1430937429742777, 0.1439941095172835, 0.1442715467959926, 0.144324968798154, 0.1451281618994793, 0.14539900726812757, 0.14543965833703817, 0.14563427541710014, 0.14611714182662167, 0.1463085598160843, 0.14634149943112626, 0.1467315423774952, 0.14691322919626357, 0.14719424689711777, 0.147861930006676, 0.14824044615885393, 0.1510226850719458, 0.15258666476394003, 0.1533202284402304, 0.15343841398432542, 0.15348617083964583, 0.15419525327337857, 0.15438496976439375, 0.1545433340112169, 0.15493459236083035, 0.1556906468172368, 0.15662566470964534, 0.15674661494639805, 0.15680899021159184, 0.15682187171455483, 0.15769018229768336, 0.15805710914214782, 0.15850045925750533, 0.1595148353483256, 0.1601049831397593, 0.16019437238373951, 0.16043964154089954, 0.1604789792333868, 0.16086520804008164, 0.16113697825757767, 0.16151079675267022, 0.16157745938382165, 0.1619975847593328, 0.16257412389638728, 0.16271549080356537, 0.1630537030461969, 0.16355529787480155, 0.16370207401196493, 0.16392636580087513, 0.16521332438881067, 0.16532571138092914, 0.16767358415269884, 0.16967484170648234, 0.17031364324344278, 0.17077388238748062, 0.1716705665158792, 0.17185138058785884, 0.17213955338489267, 0.17237602877065572, 0.1724183597958438, 0.1727041374976991, 0.17468412856785515, 0.17480199822398726, 0.17571948628929268, 0.1760706114590568, 0.17635248118364824, 0.1763672452742424, 0.17679922049258023, 0.17841157037073319, 0.17874353778172392, 0.17876818053759694, 0.17927353333486948, 0.18000763296039152, 0.18095295138956868, 0.18260470492137768, 0.18429353344689475, 0.184399704596638, 0.18637083780230698, 0.18655337598127356, 0.18689838008365428, 0.18713507903060445, 0.18778340193693813, 0.18881260856631787, 0.1902533227512195, 0.19035996933243018, 0.19135308286382713, 0.19291737611309934, 0.19300065595241517, 0.1931839386407223, 0.195159806824698, 0.1957033133504214, 0.19578622707305632, 0.1957982968954182, 0.19587346746155992, 0.19667457493479334, 0.19694601793462851, 0.19783876530909916, 0.19796962338712315, 0.1983886817009519, 0.19898414209584123, 0.1992651987688648, 0.20012260164018103, 0.20064279112221947, 0.2010914242885382, 0.20148686907168814, 0.2016695167554317, 0.2017236883642673, 0.20278866978359422, 0.20283762886198442, 0.20305726050252973, 0.20375520306594536, 0.20476842479898313, 0.2068959656443985, 0.20724454474941234, 0.20834752465717035, 0.2100472715285307, 0.21203658215612578, 0.21223807197990507, 0.21381427079046367, 0.21394745682422253, 0.21572967286053088, 0.21581232979889134, 0.21821016029151738, 0.22329259048226377, 0.22560745329518556, 0.22854754931369914, 0.23082394364507014, 0.23213861755782592, 0.2361083994805132, 0.23698246607392404, 0.23839275927835618, 0.23982882994289711, 0.24085417982305812, 0.24179808289522287, 0.24449958435208768, 0.2446223575050194, 0.24725466058766857, 0.2514472503658898, 0.2516549415333526, 0.25174347173813033, 0.25320597043186227, 0.25492351503581717, 0.25501324000339215, 0.2556801496181414, 0.25578556023214877, 0.2601218618835336, 0.261387778463596, 0.26238131519912605, 0.26295226380643727, 0.26363267293660336, 0.26550490119797, 0.2682463197480093, 0.2700781347828132, 0.2702547038744967, 0.2708334796071967, 0.2712864217777748, 0.2719856157256534, 0.27738237013158906, 0.2779028832249949, 0.2792486116494664, 0.2815295081398111, 0.2833291603790706, 0.28526259671395904, 0.2910231132909558, 0.2912341262723919, 0.291814993743338, 0.2974465273706956, 0.29834806375785966, 0.3002605000230631, 0.3026161083762028, 0.3036366774110785, 0.30554501896622943, 0.31671758259286537, 0.3177947892358563, 0.31896832334339037, 0.3225973579992369, 0.32394821441410654, 0.328401148860137, 0.33123688096980175, 0.3333720482532786, 0.33486155961425845, 0.3376657995820996, 0.3465310093353179, 0.34712442691287615, 0.35718387815910213, 0.3637860096264038, 0.37156766128430746, 0.3767621320916645, 0.38738196831935445, 0.39015245075993504, 0.39361275550223884, 0.40246495438623103, 0.40808496796036176, 0.41018257424605387, 0.4119309261467574, 0.41278133873825174, 0.415407296870261, 0.4335316716706634, 0.43646864677958636, 0.4472676674140644, 0.45242502751906954, 0.4642590638749348, 0.46955189347067494, 0.4760541182721122, 0.47774122636611555, 0.4934736513589084, 0.5157588325056031, 0.5887590073282019, 0.6220329303321976, 0.6950849438242498, 0.8529697839528887]

sObs = EMpht.Sample(obs=sortedObs)
ph1unif = empht(sObs, p=1, method=:unif)
ph1ode = empht(sObs, p=1, method=:ode)

@test -ph1unif.T[1,1] ≈ trueRate atol=1
@test -ph1ode.T[1,1] ≈ trueRate atol=1

# Fit binned samples from a gamma distribution.
trueDist = Gamma(20, 2/10)
xGrid = range(0, 8, length=1_000)
truePDFs = pdf.(trueDist, xGrid)

# Random.seed!(1)
# data = rand(trueDist, 1_000)
# int, intweight = bin_observations(data, 15)
int = [1.5 2.0; 2.0 2.5; 2.5 3.0; 3.0 3.5; 3.5 4.0; 4.0 4.5; 4.5 5.0; 5.0 5.5;
        5.5 6.0; 6.0 6.5; 6.5 7.0; 7.0 7.5]
intweight = [4.0, 34.0, 107.0, 170.0, 202.0, 222.0, 140.0, 77.0, 24.0, 14.0,
        4.0, 2.0]
sInt = EMpht.Sample(int=int, intweight=intweight)

phCF1 = empht(sInt, p=100, ph_structure="CanonicalForm1")
fitPDFs = pdf.(phCF1, xGrid)

@test norm(truePDFs .- fitPDFs, Inf) <= 1e-1

# Test that reading settings from a file works.
ph100 = empht("Coxian100.json")

# Test that some of the internal functions work as expected.
π=[0.005632862236468221, 0.00898302181442919, 0.007418596691981033,
        0.020026201266915976, 0.04062880012941406, 0.05812175206666447,
        0.04260242040415281, 0.1654039105298598, 0.3888838419368729,
        0.2622985929232415]
T = [-1.7486539983379394 1.7486539983379394 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0;
        0.0 -1.9875507782505892 1.9875507782505892 0.0 0.0 0.0 0.0 0.0 0.0 0.0;
        0.0 0.0 -1.9962263354076826 1.9962263354076826 0.0 0.0 0.0 0.0 0.0 0.0;
        0.0 0.0 0.0 -2.064044688471394 2.064044688471394 0.0 0.0 0.0 0.0 0.0;
        0.0 0.0 0.0 0.0 -2.1489226352793827 2.1489226352793827 0.0 0.0 0.0 0.0;
        0.0 0.0 0.0 0.0 0.0 -2.2809066095317565 2.2809066095317565 0.0 0.0 0.0;
        0.0 0.0 0.0 0.0 0.0 0.0 -2.5379722045000195 2.5379722045000195 0.0 0.0;
        0.0 0.0 0.0 0.0 0.0 0.0 0.0 -2.763746562995887 2.763746562995887 0.0;
        0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 -3.082614321671955 3.082614321671955;
        0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 -3.910958867504505]
t=[0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 3.910958867504505]
ph = EMpht.PhaseType(π, T, t)

u = zeros(ph.p * ph.p)
du = similar(u)
EMpht.ode_observations!(du, u, ph, 10.0)

duCorrect = [0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 5.60666e-10, 0.0, 0.0,
        0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 3.8095e-9, 0.0, 0.0, 0.0, 0.0, 0.0,
        0.0, 0.0, 0.0, 0.0, 2.46331e-8, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
        0.0, 1.15854e-7, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
        4.26538e-7, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 1.23682e-6,
        0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 2.71623e-6, 0.0, 0.0, 0.0,
        0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 5.29954e-6, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
        0.0, 0.0, 0.0, 8.87025e-6, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
        1.093e-5]
@test norm(du .- duCorrect, Inf) <= 1e-10

EMpht.ode_censored!(du, u, ph, 10.0)

duCorrect = [1.43358e-10, 1.43358e-10, 1.43358e-10, 1.43358e-10, 1.43358e-10,
        1.43358e-10, 1.43358e-10, 1.43358e-10, 1.43358e-10, 1.43358e-10,
        9.74057e-10, 9.74057e-10, 9.74057e-10, 9.74057e-10, 9.74057e-10,
        9.74057e-10, 9.74057e-10, 9.74057e-10, 9.74057e-10, 9.74057e-10,
        6.29847e-9, 6.29847e-9, 6.29847e-9, 6.29847e-9, 6.29847e-9, 6.29847e-9,
        6.29847e-9, 6.29847e-9, 6.29847e-9, 6.29847e-9, 2.96229e-8, 2.96229e-8,
        2.96229e-8, 2.96229e-8, 2.96229e-8, 2.96229e-8, 2.96229e-8, 2.96229e-8,
        2.96229e-8, 2.96229e-8, 1.09062e-7, 1.09062e-7, 1.09062e-7, 1.09062e-7,
        1.09062e-7, 1.09062e-7, 1.09062e-7, 1.09062e-7, 1.09062e-7, 1.09062e-7,
        3.16245e-7, 3.16245e-7, 3.16245e-7, 3.16245e-7, 3.16245e-7, 3.16245e-7,
        3.16245e-7, 3.16245e-7, 3.16245e-7, 3.16245e-7, 6.94519e-7, 6.94519e-7,
        6.94519e-7, 6.94519e-7, 6.94519e-7, 6.94519e-7, 6.94519e-7, 6.94519e-7,
        6.94519e-7, 6.94519e-7, 1.35505e-6, 1.35505e-6, 1.35505e-6, 1.35505e-6,
        1.35505e-6, 1.35505e-6, 1.35505e-6, 1.35505e-6, 1.35505e-6, 1.35505e-6,
        2.26805e-6, 2.26805e-6, 2.26805e-6, 2.26805e-6, 2.26805e-6, 2.26805e-6,
        2.26805e-6, 2.26805e-6, 2.26805e-6, 2.26805e-6, 2.7947e-6, 2.7947e-6,
        2.7947e-6, 2.7947e-6, 2.7947e-6, 2.7947e-6, 2.7947e-6, 2.7947e-6,
        2.7947e-6, 2.7947e-6]

@test norm(du .- duCorrect, Inf) <= 1e-10

cIntCorrect = [1.95424e-7, 1.37498e-7, 8.25671e-8, 3.9341e-8, 1.42689e-8,
        3.6283e-9, 5.76897e-10, 5.8746e-11, 2.60493e-12, 1.13063e-14,
        1.09161e-6, 7.68042e-7, 4.61207e-7, 2.19753e-7, 7.97037e-8, 2.02671e-8,
        3.22246e-9, 3.28146e-10, 1.45507e-11, 6.3155e-14, 4.93283e-6,
        3.47068e-6, 2.08413e-6, 9.93034e-7, 3.6017e-7, 9.15845e-8, 1.45619e-8,
        1.48285e-9, 6.57528e-11, 2.85389e-13, 1.56191e-5, 1.09894e-5,
        6.59911e-6, 3.1443e-6, 1.14043e-6, 2.89989e-7, 4.6108e-8, 4.69522e-9,
        2.08197e-10, 9.03644e-13, 3.88217e-5, 2.73145e-5, 1.64023e-5,
        7.81523e-6, 2.83456e-6, 7.20775e-7, 1.14603e-7, 1.16701e-8, 5.17479e-10,
        2.24603e-12, 7.8674e-5, 5.53541e-5, 3.324e-5, 1.58379e-5, 5.74438e-6,
        1.46069e-6, 2.32248e-7, 2.365e-8, 1.0487e-9, 4.55169e-12, 0.000128921,
        9.07072e-5, 5.44694e-5, 2.59532e-5, 9.41315e-6, 2.39359e-6, 3.80578e-7,
        3.87547e-8, 1.71847e-9, 7.45873e-12, 0.000195269, 0.000137389,
        8.25018e-5, 3.93099e-5, 1.42576e-5, 3.62543e-6, 5.7644e-7, 5.86995e-8,
        2.60287e-9, 1.12973e-11, 0.000264903, 0.000186383, 0.000111922,
        5.33279e-5, 1.93419e-5, 4.91827e-6, 7.82001e-7, 7.9632e-8, 3.53106e-9,
        1.5326e-11, 0.000282308, 0.000198628, 0.000119276, 5.68317e-5,
        2.06127e-5, 5.24141e-6, 8.3338e-7, 8.4864e-8, 3.76306e-9, 1.63329e-11]

@test norm(EMpht.c_integrand(5.0, ph, 10.0) .- cIntCorrect, Inf) <= 1e-8

dIntCorrect = [2.49838e-7, 1.38082e-7, 6.89019e-8, 2.75403e-8, 8.48015e-9,
        1.84014e-9, 2.4941e-10, 2.21039e-11, 8.4793e-13, 2.89092e-15,
        1.39556e-6, 7.71302e-7, 3.84875e-7, 1.53836e-7, 4.73688e-8, 1.02787e-8,
        1.39317e-9, 1.23469e-10, 4.7364e-12, 1.61482e-14, 6.30634e-6,
        3.48541e-6, 1.7392e-6, 6.95164e-7, 2.14053e-7, 4.64482e-8, 6.29553e-9,
        5.57939e-10, 2.14032e-11, 7.29717e-14, 1.99681e-5, 1.1036e-5,
        5.50693e-6, 2.20114e-6, 6.77769e-7, 1.47071e-7, 1.99339e-8, 1.76663e-9,
        6.77701e-11, 2.31054e-13, 4.96313e-5, 2.74304e-5, 1.36876e-5,
        5.47098e-6, 1.68461e-6, 3.6555e-7, 4.95462e-8, 4.39101e-9, 1.68444e-10,
        5.74291e-13, 0.00010058, 5.5589e-5, 2.77386e-5, 1.10872e-5, 3.41395e-6,
        7.40805e-7, 1.00408e-7, 8.8986e-9, 3.41361e-10, 1.16383e-12,
        0.000164818, 9.10922e-5, 4.54545e-5, 1.81683e-5, 5.59434e-6, 1.21394e-6,
        1.64535e-7, 1.45819e-8, 5.59378e-10, 1.90714e-12, 0.000249641,
        0.000137972, 6.88474e-5, 2.75185e-5, 8.47344e-6, 1.83868e-6, 2.49213e-7,
        2.20864e-8, 8.47259e-10, 2.88863e-12, 0.000338663, 0.000187174,
        9.33986e-5, 3.73317e-5, 1.14951e-5, 2.49436e-6, 3.38083e-7, 2.99624e-8,
        1.14939e-9, 3.91873e-12, 0.000360914, 0.000199471, 9.95351e-5,
        3.97845e-5, 1.22503e-5, 2.65825e-6, 3.60296e-7, 3.1931e-8, 1.22491e-9,
        4.1762e-12]

@test norm(EMpht.d_integrand(5.0, ph, 10.0) .- dIntCorrect, Inf) <= 1e-8


p = ph.p; Bs = zeros(p); Zs = zeros(p); Ns = zeros(p, p+1)

EMpht.e_step_observed_ode!(sObs, ph, Bs, Zs, Ns)

BsCorrect = [9.02369e-6, 9.24901e-5, 0.00041208, 0.00568032, 0.0558114,
        0.377397, 1.30242, 23.3691, 251.208, 723.681]
ZsCorrect = [7.43742e-7, 8.80107e-6, 4.71973e-5, 0.000600675, 0.00613343,
        0.04273, 0.160008, 2.10905, 21.4158, 71.7403]
NsCorrect = [0.0 9.02399e-6 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0;
        0.0 0.0 0.000101516 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0;
        0.0 0.0 0.0 0.000513599 0.0 0.0 0.0 0.0 0.0 0.0 0.0;
        0.0 0.0 0.0 0.0 0.0061939 0.0 0.0 0.0 0.0 0.0 0.0;
        0.0 0.0 0.0 0.0 0.0 0.062005 0.0 0.0 0.0 0.0 0.0;
        0.0 0.0 0.0 0.0 0.0 0.0 0.439402 0.0 0.0 0.0 0.0;
        0.0 0.0 0.0 0.0 0.0 0.0 0.0 1.74183 0.0 0.0 0.0;
        0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 25.1109 0.0 0.0;
        0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 276.319 0.0;
        0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 1000.0]

@test norm(Bs .- BsCorrect, Inf) <= 1e-3
@test norm(Zs .- ZsCorrect, Inf) <= 1e-3
@test norm(Ns .- NsCorrect, Inf) <= 1e-3


p = ph.p; Bs = zeros(p); Zs = zeros(p); Ns = zeros(p, p+1)

EMpht.e_step_censored_ode!(sInt, ph, Bs, Zs, Ns)

BsCorrect = [130.738, 174.776, 108.273, 188.54, 206.27, 126.544, 29.5952,
        26.7001, 8.34855, 0.214886]
ZsCorrect = [79.0644, 173.84, 245.305, 376.65, 533.48, 617.446, 565.593,
        538.451, 475.918, 341.487]
NsCorrect = [0.0 130.737 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0;
        0.0 0.0 305.513 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0;
        0.0 0.0 0.0 413.787 0.0 0.0 0.0 0.0 0.0 0.0 0.0;
        0.0 0.0 0.0 0.0 602.329 0.0 0.0 0.0 0.0 0.0 0.0;
        0.0 0.0 0.0 0.0 0.0 808.599 0.0 0.0 0.0 0.0 0.0;
        0.0 0.0 0.0 0.0 0.0 0.0 935.148 0.0 0.0 0.0 0.0;
        0.0 0.0 0.0 0.0 0.0 0.0 0.0 964.712 0.0 0.0 0.0;
        0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 991.49 0.0 0.0;
        0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 999.738 0.0;
        0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 1000.0]

@test norm(Bs .- BsCorrect, Inf) <= 1e-3
@test norm(Zs .- ZsCorrect, Inf) <= 1e-3
@test norm(Ns .- NsCorrect, Inf) <= 1e-3
